name: üéÆ VPS Windows + Sunshine + Moonlight

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360   # VPS ch·∫°y t·ªëi ƒëa 6h

    steps:
    - name: ‚öôÔ∏è Setup User + RDP
      run: |
        # B·∫≠t RDP ƒë·ªÉ ph√≤ng tr∆∞·ªùng h·ª£p c·∫ßn
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        net user datlohe Dat@123456 /add
        net localgroup administrators datlohe /add
        Write-Host "‚úÖ User: datlohe / Password: Dat@123456"

    - name: üåû C√†i Sunshine (Portable)
      run: |
        Invoke-WebRequest -Uri "https://github.com/LizardByte/Sunshine/releases/download/v0.23.1/sunshine-windows.zip" -OutFile "sunshine.zip"
        Expand-Archive sunshine.zip -DestinationPath "C:\Sunshine" -Force
        cd C:\Sunshine
        Write-Host "‚úÖ Sunshine Portable ƒë√£ gi·∫£i n√©n!"

        # M·ªü firewall cho Moonlight
        New-NetFirewallRule -DisplayName "Sunshine TCP 47984" -Direction Inbound -Protocol TCP -LocalPort 47984 -Action Allow
        New-NetFirewallRule -DisplayName "Sunshine TCP 47989" -Direction Inbound -Protocol TCP -LocalPort 47989 -Action Allow
        New-NetFirewallRule -DisplayName "Sunshine UDP 48010" -Direction Inbound -Protocol UDP -LocalPort 48010 -Action Allow

        # Ch·∫°y Sunshine n·ªÅn
        Start-Process -FilePath "C:\Sunshine\sunshine.exe" -ArgumentList "-config C:\Sunshine\config\sunshine.conf" -NoNewWindow
    - name: ‚òÅÔ∏è C√†i Cloudflared
      run: |
        Invoke-WebRequest https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe
        Write-Host "‚úÖ Cloudflared t·∫£i xong!"

        # T·∫°o tunnel cho Sunshine (47984 TCP)
        Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel --url tcp://localhost:47984" -NoNewWindow

        Start-Sleep -Seconds 15
        Write-Host "============================"
        Write-Host "üåç VPS s·∫µn s√†ng!"
        Write-Host "üë§ User: datlohe"
        Write-Host "üîë Password: Dat@123456"
        Write-Host "üëâ M·ªü Moonlight, th√™m server v·ªõi link hi·ªÉn th·ªã trong log Cloudflared ·ªü tr√™n"
        Write-Host "============================"

    - name: ‚è≥ Gi·ªØ VPS ch·∫°y
      run: |
        while ($true) { Start-Sleep -Seconds 60 }
